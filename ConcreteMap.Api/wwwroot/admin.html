<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="admin-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <h1>üõ†Ô∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
            <a href="index.html" target="_blank" class="btn" style="background: #e9ecef; color: #333; text-decoration: none;">üåç –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</a>
        </div>
        <button id="logout-btn" class="btn btn-danger">–í—ã–π—Ç–∏</button>
    </header>
    <div class="admin-container">
        <div class="upload-card">
            <span class="upload-icon">üìÇ</span>
            <h2 style="margin-top: 0;">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
            <p style="color: #666; margin-bottom: 20px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Excel —Ñ–∞–π–ª —Å –∑–∞–≤–æ–¥–∞–º–∏</p>
            <div style="margin-bottom: 20px;"><input type="file" id="excel-file" accept=".xlsx" class="btn"></div>
            <button id="upload-btn" class="btn btn-primary" style="width: 200px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É</button>
            <div id="status-msg" class="status-box"></div>
        </div>
    </div>
    <script>
        const token = localStorage.getItem('jwt_token');
        if (!token) window.location.href = 'login.html';
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('jwt_token'); window.location.href = 'login.html';
        });
        document.getElementById('upload-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('excel-file');
            const statusMsg = document.getElementById('status-msg');
            const btn = document.getElementById('upload-btn');
            if (!fileInput.files[0]) { statusMsg.textContent = '‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'; statusMsg.style.color = '#dc3545'; return; }
            btn.disabled = true; btn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞..."; statusMsg.textContent = "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞..."; statusMsg.style.color = "#007bff";
            const formData = new FormData(); formData.append('file', fileInput.files[0]);
            try {
                const response = await fetch('/api/Import/factories', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    body: formData
                });

                const data = await response.json(); // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å JSON

                if (response.ok) {
                    statusMsg.textContent = `‚úÖ –£—Å–ø–µ—à–Ω–æ! –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${data.count} —Å—Ç—Ä–æ–∫. –ë–∞–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.`;
                    statusMsg.style.color = "#28a745";
                    fileInput.value = "";
                } else if (response.status === 401) {
                    statusMsg.textContent = '‚õî –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.';
                    statusMsg.style.color = '#dc3545';
                    setTimeout(() => {
                        localStorage.removeItem('jwt_token');
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –æ—à–∏–±–∫—É —Å —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞...")
                    statusMsg.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.message || data || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                    statusMsg.style.color = '#dc3545';
                }
            } catch (error) {
                console.error(error);
                statusMsg.textContent = '‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç.';
                statusMsg.style.color = '#dc3545';
            }
            finally { btn.disabled = false; btn.textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É"; }
        });
    </script>
</body>
</html>