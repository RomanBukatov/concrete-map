<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="admin-header">
        <h1>üõ†Ô∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
        <div style="display:flex; gap:10px;">
             <a href="index.html" target="_blank" class="btn" style="background: #e9ecef; color: #333; text-decoration: none;">üåç –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</a>
             <button id="logout-btn" class="btn btn-danger">–í—ã–π—Ç–∏</button>
        </div>
    </header>
    <div class="admin-container">
        <!-- –ò–º–ø–æ—Ä—Ç -->
        <div class="upload-card" style="margin-bottom: 30px;">
            <span class="upload-icon">üìÇ</span>
            <h2 style="margin-top: 0;">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
            <p style="color: #666; margin-bottom: 20px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Excel —Ñ–∞–π–ª —Å –∑–∞–≤–æ–¥–∞–º–∏</p>
            <div style="margin-bottom: 20px;"><input type="file" id="excel-file" accept=".xlsx" class="btn"></div>
            <button id="upload-btn" class="btn btn-primary" style="width: 200px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É</button>
            <div id="status-msg" class="status-box"></div>
        </div>
        <!-- –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è -->
        <div class="upload-card">
            <h2 style="margin-top: 0; font-size: 18px;">üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
            <div style="max-width: 300px; margin: 0 auto; text-align: left;">
                <div class="form-group">
                    <label style="font-size: 12px; font-weight: bold;">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="old-pass" placeholder="***" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label style="font-size: 12px; font-weight: bold;">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="new-pass" placeholder="***" style="width: 100%;">
                </div>
                <button id="change-pass-btn" class="btn btn-primary" style="width: 100%;">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                <div id="pass-msg" style="text-align: center; margin-top: 10px; font-size: 14px;"></div>
            </div>
        </div>
    </div>
    <script>
        const token = localStorage.getItem('jwt_token');
        if (!token) window.location.href = 'login.html';

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('jwt_token'); window.location.href = 'login.html';
        });

        document.getElementById('upload-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('excel-file');
            const statusMsg = document.getElementById('status-msg');
            const btn = document.getElementById('upload-btn');
            if (!fileInput.files[0]) { statusMsg.textContent = '‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'; statusMsg.style.color = '#dc3545'; return; }
            btn.disabled = true; btn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞..."; statusMsg.textContent = "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞..."; statusMsg.style.color = "#007bff";
            const formData = new FormData(); formData.append('file', fileInput.files[0]);
            try {
                const response = await fetch('/api/Import/factories', {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: formData
                });
                const data = await response.json();
                if (response.ok) { statusMsg.textContent = `‚úÖ –£—Å–ø–µ—à–Ω–æ! –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${data.count} —Å—Ç—Ä–æ–∫.`; statusMsg.style.color = "#28a745"; fileInput.value = ""; } 
                else { throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); }
            } catch (error) {
                statusMsg.textContent = `‚ùå ${error.message}`; statusMsg.style.color = '#dc3545';
                if (error.message.includes("401")) { localStorage.removeItem('jwt_token'); window.location.href = 'login.html'; }
            } finally { btn.disabled = false; btn.textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É"; }
        });

        document.getElementById('change-pass-btn').addEventListener('click', async () => {
            const oldPass = document.getElementById('old-pass').value;
            const newPass = document.getElementById('new-pass').value;
            const msg = document.getElementById('pass-msg');
            const btn = document.getElementById('change-pass-btn');
            if (!oldPass || !newPass) { msg.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è"; msg.style.color = "red"; return; }
            btn.disabled = true;
            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldPassword: oldPass, newPassword: newPass })
                });
                let data;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const json = await response.json();
                    data = json.message || JSON.stringify(json);
                } else { data = await response.text(); }

                if (response.ok) {
                    msg.textContent = "‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!"; msg.style.color = "green";
                    document.getElementById('old-pass').value = ""; document.getElementById('new-pass').value = "";
                } else { msg.textContent = `‚ùå ${data}`; msg.style.color = "red"; }
            } catch (error) { msg.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"; msg.style.color = "red"; } 
            finally { btn.disabled = false; }
        });
    </script>
</body>
</html>