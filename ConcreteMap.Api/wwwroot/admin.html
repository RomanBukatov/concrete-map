<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="admin-header">
        <h1 id="page-title">üõ†Ô∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
        <div style="display:flex; gap:10px;">
             <a href="index.html" target="_blank" class="btn" style="background: #e9ecef; color: #333; text-decoration: none;">üåç –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</a>
             <button id="logout-btn" class="btn btn-danger">–í—ã–π—Ç–∏</button>
        </div>
    </header>
    
    <div class="admin-container">
        <!-- 1. –ò–º–ø–æ—Ä—Ç (–¢–æ–ª—å–∫–æ –ê–¥–º–∏–Ω) -->
        <div id="card-import" class="upload-card" style="margin-bottom: 30px;">
            <span class="upload-icon">üìÇ</span>
            <h2 style="margin-top: 0;">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
            <p style="color: #666; margin-bottom: 20px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Excel —Ñ–∞–π–ª —Å –∑–∞–≤–æ–¥–∞–º–∏</p>
            <div style="margin-bottom: 20px;"><input type="file" id="excel-file" accept=".xlsx" class="btn"></div>
            <button id="upload-btn" class="btn btn-primary" style="width: 200px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É</button>
            <div id="status-msg" class="status-box"></div>
            <hr>
            <button id="export-btn" class="btn" style="width: 100%; background: #28a745; color: white; margin-top: 10px;">üì• –°–∫–∞—á–∞—Ç—å —Ç–µ–∫—É—â—É—é –±–∞–∑—É</button>
        </div>

        <!-- 2. –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–¢–æ–ª—å–∫–æ –ê–¥–º–∏–Ω) -->
        <div id="card-users" class="upload-card" style="margin-bottom: 30px;">
            <span class="upload-icon">üë§</span>
            <h2 style="margin-top: 0;">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
            <p style="color: #666; margin-bottom: 20px;">–°–æ–∑–¥–∞—Ç—å —É—á–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞</p>
            <div style="max-width: 300px; margin: 0 auto; text-align: left;">
                <div class="form-group">
                    <label style="font-size: 12px; font-weight: bold;">–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="new-user-login" placeholder="manager" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label style="font-size: 12px; font-weight: bold;">–ü–∞—Ä–æ–ª—å</label>
                    <input type="text" id="new-user-pass" placeholder="secret123" style="width: 100%;">
                </div>
                <button id="create-user-btn" class="btn btn-primary" style="width: 100%;">–°–æ–∑–¥–∞—Ç—å</button>
                <div id="user-msg" class="status-box"></div>
            </div>
        </div>

        <!-- 3. –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è (–î–ª—è –≤—Å–µ—Ö) -->
        <div id="card-password" class="upload-card">
            <h2 style="margin-top: 0; font-size: 18px;">üîê –°–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –ø–∞—Ä–æ–ª—å</h2>
            <div style="max-width: 300px; margin: 0 auto; text-align: left;">
                <div class="form-group">
                    <label style="font-size: 12px; font-weight: bold;">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="old-pass" placeholder="***" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label style="font-size: 12px; font-weight: bold;">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="new-pass" placeholder="***" style="width: 100%;">
                </div>
                <button id="change-pass-btn" class="btn btn-primary" style="width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <div id="pass-msg" style="text-align: center; margin-top: 10px; font-size: 14px;"></div>
            </div>
        </div>

        <!-- 4. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–π—Å–∞–º–∏ -->
        <div class="upload-card">
            <span class="upload-icon">üìë</span>
            <h2 style="margin-top: 0;">–ü—Ä–∞–π—Å-–ª–∏—Å—Ç—ã –∑–∞–≤–æ–¥–æ–≤</h2>
            <p style="color: #666; margin-bottom: 20px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–≤–æ–¥–∞</p>
           
            <input type="text" id="factory-search" placeholder="üîç –ù–∞–π—Ç–∏ –∑–∞–≤–æ–¥..." style="margin-bottom: 15px;">
           
            <div id="factories-list" style="max-height: 400px; overflow-y: auto; text-align: left; border: 1px solid #eee; border-radius: 6px;">
                <!-- –°—é–¥–∞ JS –±—É–¥–µ—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ -->
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('jwt_token');
        const role = localStorage.getItem('user_role');

        if (!token) window.location.href = 'login.html';

        // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —Ä–æ–ª—è–º
        if (role !== 'Admin') {
            // –°–∫—Ä—ã–≤–∞–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –±–ª–æ–∫–∏
            document.getElementById('card-import').style.display = 'none';
            document.getElementById('card-users').style.display = 'none';
            // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('page-title').textContent = 'üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–≤–æ–¥–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–π—Å–∞–º–∏
        async function loadFactoriesForAdmin() {
            try {
                const response = await fetch('/api/Factories', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∑–∞–≤–æ–¥–æ–≤');
                const factories = await response.json();
                renderFactoriesList(factories);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        function renderFactoriesList(factories) {
            const listDiv = document.getElementById('factories-list');
            listDiv.innerHTML = '';
            
            factories.forEach(factory => {
                const factoryDiv = document.createElement('div');
                factoryDiv.style.padding = '10px';
                factoryDiv.style.borderBottom = '1px solid #eee';
                
                const statusText = factory.priceListUrl ? '‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω' : '‚ùå –ù–µ—Ç —Ñ–∞–π–ª–∞';
                
                factoryDiv.innerHTML = `
                    <b>${factory.name}</b>
                    <span id="status-${factory.id}">${statusText}</span>
                    <br>
                    <input type="file" id="file-${factory.id}" style="display:none" onchange="uploadPrice(${factory.id})">
                    <button class="btn btn-sm btn-primary" onclick="document.getElementById('file-${factory.id}').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    <button class="btn btn-sm btn-danger" onclick="deletePrice(${factory.id})">–£–¥–∞–ª–∏—Ç—å</button>
                `;
                
                listDiv.appendChild(factoryDiv);
            });
        }

        async function uploadPrice(factoryId) {
            const fileInput = document.getElementById(`file-${factoryId}`);
            const file = fileInput.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`/api/PriceList/${factoryId}`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById(`status-${factoryId}`).textContent = '‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω';
                    fileInput.value = '';
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
            }
        }

        async function deletePrice(factoryId) {
            try {
                const response = await fetch(`/api/PriceList/${factoryId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (response.ok) {
                    document.getElementById(`status-${factoryId}`).textContent = '‚ùå –ù–µ—Ç —Ñ–∞–π–ª–∞';
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –∑–∞–≤–æ–¥–æ–≤
        document.getElementById('factory-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const factories = Array.from(document.querySelectorAll('#factories-list > div'));
            factories.forEach(factoryDiv => {
                const name = factoryDiv.querySelector('b').textContent.toLowerCase();
                factoryDiv.style.display = name.includes(searchTerm) ? 'block' : 'none';
            });
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–≤–æ–¥–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadFactoriesForAdmin();

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user_role'); // –ù–µ –∑–∞–±—ã–≤–∞–µ–º —á–∏—Å—Ç–∏—Ç—å —Ä–æ–ª—å
            window.location.href = 'login.html';
        });

        // –õ–æ–≥–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ (–°—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —É –ê–¥–º–∏–Ω–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —é–∑–µ—Ä —Ä–∞—Å–∫—Ä–æ–µ—Ç HTML, —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø—É—Å—Ç–∏—Ç)
        document.getElementById('upload-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('excel-file');
            const statusMsg = document.getElementById('status-msg');
            const btn = document.getElementById('upload-btn');
            if (!fileInput.files[0]) { statusMsg.textContent = '‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'; statusMsg.style.color = '#dc3545'; return; }
            btn.disabled = true; btn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞..."; statusMsg.textContent = "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞..."; statusMsg.style.color = "#007bff";
            const formData = new FormData(); formData.append('file', fileInput.files[0]);
            try {
                const response = await fetch('/api/Import/factories', {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: formData
                });
                const data = await response.json();
                if (response.ok) { statusMsg.textContent = `‚úÖ –£—Å–ø–µ—à–Ω–æ! –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${data.count} —Å—Ç—Ä–æ–∫.`; statusMsg.style.color = "#28a745"; fileInput.value = ""; }
                else { throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); }
            } catch (error) {
                statusMsg.textContent = `‚ùå ${error.message}`; statusMsg.style.color = '#dc3545';
                if (error.message.includes("401")) { logout(); }
            } finally { btn.disabled = false; btn.textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É"; }
        });

        // –õ–æ–≥–∏–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
        document.getElementById('export-btn').addEventListener('click', async () => {
            const btn = document.getElementById('export-btn');
            btn.disabled = true;
            btn.textContent = "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ...";

            try {
                const response = await fetch('/api/Export/factories', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "factories_export.xlsx";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    alert("–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è");
                }
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
            } finally {
                btn.disabled = false;
                btn.textContent = "üì• –°–∫–∞—á–∞—Ç—å —Ç–µ–∫—É—â—É—é –±–∞–∑—É";
            }
        });

        // –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —é–∑–µ—Ä–∞
        document.getElementById('create-user-btn').addEventListener('click', async () => {
            const login = document.getElementById('new-user-login').value;
            const pass = document.getElementById('new-user-pass').value;
            const msg = document.getElementById('user-msg');
            const btn = document.getElementById('create-user-btn');
            if (!login || !pass) { msg.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è"; msg.style.color = "red"; return; }
            btn.disabled = true;
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: login, password: pass })
                });
                const data = await response.text(); // –∏–ª–∏ json, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
                if (response.ok) {
                    msg.textContent = `‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ "${login}" —Å–æ–∑–¥–∞–Ω!`; msg.style.color = "green";
                    document.getElementById('new-user-login').value = ""; document.getElementById('new-user-pass').value = "";
                } else { msg.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data}`; msg.style.color = "red"; }
            } catch (error) { msg.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"; msg.style.color = "red"; } 
            finally { btn.disabled = false; }
        });

        // –õ–æ–≥–∏–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
        document.getElementById('change-pass-btn').addEventListener('click', async () => {
            const oldPass = document.getElementById('old-pass').value;
            const newPass = document.getElementById('new-pass').value;
            const msg = document.getElementById('pass-msg');
            const btn = document.getElementById('change-pass-btn');
            if (!oldPass || !newPass) { msg.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è"; msg.style.color = "red"; return; }
            btn.disabled = true;
            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldPassword: oldPass, newPassword: newPass })
                });
                let data;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const json = await response.json();
                    data = json.message || JSON.stringify(json);
                } else { data = await response.text(); }

                if (response.ok) {
                    msg.textContent = "‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!"; msg.style.color = "green";
                    document.getElementById('old-pass').value = ""; document.getElementById('new-pass').value = "";
                } else { msg.textContent = `‚ùå ${data}`; msg.style.color = "red"; }
            } catch (error) { msg.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"; msg.style.color = "red"; } 
            finally { btn.disabled = false; }
        });

        function logout() {
            localStorage.removeItem('jwt_token'); localStorage.removeItem('user_role'); window.location.href = 'login.html';
        }
    </script>
</body>
</html>