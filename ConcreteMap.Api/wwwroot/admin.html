<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="admin-header">
        <h1>üõ†Ô∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
        <div style="display:flex; gap:10px;">
             <a href="index.html" target="_blank" class="btn" style="background: #e9ecef; color: #333; text-decoration: none;">üåç –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</a>
             <button id="logout-btn" class="btn btn-danger">–í—ã–π—Ç–∏</button>
        </div>
    </header>
    
    <div class="admin-container">
        <!-- 1. –ò–º–ø–æ—Ä—Ç -->
        <div class="upload-card" style="margin-bottom: 30px;">
            <span class="upload-icon">üìÇ</span>
            <h2 style="margin-top: 0;">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
            <p style="color: #666; margin-bottom: 20px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Excel —Ñ–∞–π–ª —Å –∑–∞–≤–æ–¥–∞–º–∏</p>
            <div style="margin-bottom: 20px;"><input type="file" id="excel-file" accept=".xlsx" class="btn"></div>
            <button id="upload-btn" class="btn btn-primary" style="width: 200px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É</button>
            <div id="status-msg" class="status-box"></div>
        </div>

        <!-- 2. –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
        <div class="upload-card" style="margin-bottom: 30px;">
            <span class="upload-icon">üë§</span>
            <h2 style="margin-top: 0;">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
            <p style="color: #666; margin-bottom: 20px;">–°–æ–∑–¥–∞—Ç—å —É—á–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞</p>
            
            <div style="max-width: 300px; margin: 0 auto; text-align: left;">
                <div class="form-group">
                    <label style="font-size: 12px; font-weight: bold;">–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="new-user-login" placeholder="manager" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label style="font-size: 12px; font-weight: bold;">–ü–∞—Ä–æ–ª—å</label>
                    <input type="text" id="new-user-pass" placeholder="secret123" style="width: 100%;">
                </div>
                <button id="create-user-btn" class="btn btn-primary" style="width: 100%;">–°–æ–∑–¥–∞—Ç—å</button>
                <div id="user-msg" class="status-box"></div>
            </div>
        </div>

        <!-- 3. –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è -->
        <div class="upload-card">
            <h2 style="margin-top: 0; font-size: 18px;">üîê –°–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –ø–∞—Ä–æ–ª—å</h2>
            <div style="max-width: 300px; margin: 0 auto; text-align: left;">
                <div class="form-group">
                    <label style="font-size: 12px; font-weight: bold;">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="old-pass" placeholder="***" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label style="font-size: 12px; font-weight: bold;">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="new-pass" placeholder="***" style="width: 100%;">
                </div>
                <button id="change-pass-btn" class="btn btn-primary" style="width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <div id="pass-msg" style="text-align: center; margin-top: 10px; font-size: 14px;"></div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('jwt_token');
        const role = localStorage.getItem('user_role');

        // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ –ò–õ–ò —Ä–æ–ª—å –Ω–µ Admin - –≤—ã–∫–∏–¥—ã–≤–∞–µ–º
        if (!token || role !== 'Admin') {
            window.location.href = 'index.html'; // –ò–ª–∏ –Ω–∞ login.html
        }

        // –í—ã—Ö–æ–¥
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('jwt_token'); window.location.href = 'login.html';
        });

        // –ò–º–ø–æ—Ä—Ç
        document.getElementById('upload-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('excel-file');
            const statusMsg = document.getElementById('status-msg');
            const btn = document.getElementById('upload-btn');
            
            if (!fileInput.files[0]) { statusMsg.textContent = '‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'; statusMsg.style.color = '#dc3545'; return; }
            
            btn.disabled = true; btn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞..."; statusMsg.textContent = "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞..."; statusMsg.style.color = "#007bff";
            const formData = new FormData(); formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/api/Import/factories', {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: formData
                });
                const data = await response.json();
                
                if (response.ok) {
                    statusMsg.textContent = `‚úÖ –£—Å–ø–µ—à–Ω–æ! –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${data.count} —Å—Ç—Ä–æ–∫.`; statusMsg.style.color = "#28a745"; fileInput.value = "";
                } else {
                    throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }
            } catch (error) {
                statusMsg.textContent = `‚ùå ${error.message}`; statusMsg.style.color = '#dc3545';
                if (error.message.includes("401")) { localStorage.removeItem('jwt_token'); window.location.href = 'login.html'; }
            } finally { 
                btn.disabled = false; btn.textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É"; 
            }
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ —é–∑–µ—Ä–∞
        document.getElementById('create-user-btn').addEventListener('click', async () => {
            const login = document.getElementById('new-user-login').value;
            const pass = document.getElementById('new-user-pass').value;
            const msg = document.getElementById('user-msg');
            const btn = document.getElementById('create-user-btn');

            if (!login || !pass) { msg.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è"; msg.style.color = "red"; return; }

            btn.disabled = true;
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ username: login, password: pass })
                });
                
                if (response.ok) {
                    msg.textContent = `‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ "${login}" —Å–æ–∑–¥–∞–Ω!`; msg.style.color = "green";
                    document.getElementById('new-user-login').value = "";
                    document.getElementById('new-user-pass').value = "";
                } else {
                    const data = await response.text();
                    msg.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data}`; msg.style.color = "red";
                }
            } catch (error) {
                msg.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"; msg.style.color = "red";
            } finally {
                btn.disabled = false;
            }
        });

        // –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
        document.getElementById('change-pass-btn').addEventListener('click', async () => {
            const oldPass = document.getElementById('old-pass').value;
            const newPass = document.getElementById('new-pass').value;
            const msg = document.getElementById('pass-msg');
            const btn = document.getElementById('change-pass-btn');

            if (!oldPass || !newPass) { msg.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è"; msg.style.color = "red"; return; }

            btn.disabled = true;
            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ oldPassword: oldPass, newPassword: newPass })
                });
                
                let data;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const json = await response.json();
                    data = json.message || JSON.stringify(json);
                } else {
                    data = await response.text();
                }

                if (response.ok) {
                    msg.textContent = "‚úÖ –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω!"; msg.style.color = "green";
                    document.getElementById('old-pass').value = "";
                    document.getElementById('new-pass').value = "";
                } else {
                    msg.textContent = `‚ùå ${data}`; msg.style.color = "red";
                }
            } catch (error) {
                msg.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"; msg.style.color = "red";
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>